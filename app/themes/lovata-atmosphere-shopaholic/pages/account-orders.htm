title = "Account Orders"
url = "/account/orders"
layout = "main"
is_hidden = 0

[UserPage]
slug = ""
slug_required = 0
mode = "ajax"
flash_on = 0
redirect_on = 0
redirect_page = "account"
login_page = "sign-in"

[ProductData]

[Pagination]
count_per_page = 5
pagination_limit = 10
active_class = "pagination__link_current"
button_list = "last-more,last"
first_button_name = "First"
first_button_limit = 3
first_button_number = 1
first-more_button_name = "..."
first-more_button_limit = 3
prev_button_name = "Prev"
prev_button_limit = 1
prev-more_button_name = "..."
prev-more_button_limit = 1
next-more_button_name = "..."
next-more_button_limit = 1
next_button_name = "Next"
next_button_limit = 1
last-more_button_name = "..."
last-more_button_limit = 3
last_button_name = "Last"
last_button_limit = 3
last_button_number = 1
==
<?php
function onInit()
{
    $this['path_page_js'] = 'js/pages/account-orders.js';

    $bHasUserPlugin = $this['bHasUserPlugin'];

    if (!$bHasUserPlugin) {
        return $this->controller->run('404');
    }

    $obOrderList = $this->obUser->order;

    $arOrderList = $this->applyOrderFilters($obOrderList);

    $this['arOrderList'] = $arOrderList;
}

function onFilterOrders()
{
    $obOrderList = $this->obUser->order;

    $arOrderList = $this->applyOrderFilters($obOrderList);

    $this['arOrderList'] = $arOrderList;
}

private function applyOrderFilters($obOrderList)
{
    $sSearchName = (string) input('name');
    $sDateFrom   = input('date_from');
    $sDateTo     = input('date_to');
    $bDelivered  = input('delivered') !== null;

    $obOrderList = $obOrderList->regular();

    if ($sSearchName) {
        $obOrderList = $obOrderList->filterByName($sSearchName);
    }

    if ($sDateFrom || $sDateTo) {
        $from = $sDateFrom ? $sDateFrom.' 00:00:00' : null;
        $to   = $sDateTo   ? $sDateTo.' 23:59:59' : null;

        $obOrderList = $obOrderList->filterByDate($from, $to);
    }

    if (!$bDelivered) {
        $obOrderList = $obOrderList->filterByNotDelivered();
    }

    $this['sSearchName'] = $sSearchName;
    $this['sDateFrom']   = $sDateFrom;
    $this['sDateTo']     = $sDateTo;
    $this['bDelivered']  = $bDelivered;

    $iCount = $obOrderList->count();
    $iPage = $this->Pagination->getPageFromRequest();
    $perPage = $this->Pagination->getCountPerPage();

    $this['obOrderList'] = $obOrderList;

    $arOrderList = $obOrderList->page($iPage, $perPage);

    $this['iPage'] = $iPage;
    $this['iCount'] = $iCount;
    $this['bRepeatOrder'] = true;

    return $arOrderList;
}
?>
==
{% set arBreadcrumbs = [
    { 'name': 'account_my_account'|_, 'url': 'account'|page },
    { 'name': 'account_order_history'|_ }
] %}

{% partial 'common/breadcrumbs' arBreadcrumbs=arBreadcrumbs %}

<div class="mb-8 mt-1 lg:mb-16">
    <h1 class="uppercase text-xl mb-4 font-medium lg:text-3xl">{{'account_order_history'|_}}</h1>
    <form class="mb-6"  data-request="onFilterOrders" data-request-update="'account/order-list/order-list-wrapper': '#orderListWrapper'">
        <div class="flex flex-col md:flex-row md:items-center gap-4">

            {% partial 'form/input'
                placeholder = 'account_order_form_number'|_
                type = 'text'
                id = 'order_name'
                name = 'name'
                value = sSearchName
            %}

            {% partial 'form/input'
                placeholder = 'account_order_form_from'|_
                type = 'date'
                id = 'date_from'
                name = 'date_from'
                value = sDateFrom
            %}

            {% partial 'form/input'
                placeholder = 'account_order_form_to'|_
                type = 'date'
                id = 'date_to'
                name = 'date_to'
                value = sDateTo
            %}

            {% partial 'form/input-checkbox'
                id = 'delivered'
                name = 'delivered'
                labelText = 'account_order_form_delivered'|_
                checked = bDelivered
            %}

            {% partial 'form/button'
                text = 'search_search'|_
                type = 'submit'
            %}
        </div>
    </form>
    <div id="orderListWrapper">
        {% partial 'account/order-list/order-list-wrapper' obOrderList = obOrderList %}
    </div>
</div>
