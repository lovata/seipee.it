{#
Params:
- obOrderList
- bRepeatOrder
#}

{# TODO: Come up with a more correct way to transfer the color sColorState #}

{% if obOrderList is empty %}
    {% set obOrderList = obUser.order %}

    {% set iPage = Pagination.getPageFromRequest() %}
    {% set iMaxPage = Pagination.getMaxPage(iOrdersCount) %}
{% endif %}

{% set arOrderList = obOrderList.page(iPage, Pagination.getCountPerPage()) %}

{% for obOrder in arOrderList %}
{% set obTotalPriceData = obOrder.total_price_data %}
{% set obOrderPositionList = obOrder.order_position %}
{% set orderProps = obOrder.property %}
<li class="_order_item">
    <div class="bg-white border-t border-x border-outline-variant rounded-ss-md rounded-se-md overflow-hidden
    {% if not bRepeatOrder %}
        [&:has(+_.hidden)]:border-b [&:has(+_.hidden)]:rounded-es-md [&:has(+_.hidden)]:rounded-ee-md
    {% endif %}
    ">
        <div class="grid grid-cols-2 px-3 py-1 pt-2">
            <span class="text-lg font-medium">{{ 'account_order_number'|_ }}:&nbsp;</span>
            <span class="text-lg lg:text-lg font-medium text-end">
                {{ obOrder.order_number }}
            </span>
        </div>

        <div class="grid grid-cols-[30%_1fr] px-3 py-1">
            <span class="text-sm font-medium ">{{ 'account_order_date'|_ }}&nbsp;</span>
            <span class="text-sm text-end">
                {{ obOrder.created_at|date('d/m/Y') }}
            </span>
        </div>

        <div class="grid grid-cols-[30%_1fr] px-3 py-1">
            <span class="text-sm font-medium ">{{ 'account_order_rows'|_ }}&nbsp;</span>
            <span class="text-sm text-end">
                {{ obOrderPositionList.count() }}
            </span>
        </div>

        <div class="grid grid-cols-[30%_1fr] px-3 py-1">
            <span class="text-sm font-medium ">{{ 'account_order_delivery_date'|_ }}&nbsp;</span>
            <span class="text-sm text-end">
                {{ obOrder.delivery_date|date('d/m/Y') }}
            </span>
        </div>

        <div class="grid grid-cols-[30%_1fr] px-3 py-1">
            <span class="text-sm font-medium ">{{ 'account_order_payment'|_ }}&nbsp;</span>
            <span class="text-sm text-end">
                {{ obOrder.payment_type }}
            </span>
        </div>

        <div class="grid grid-cols-[30%_1fr] px-3 py-1">
            <span class="text-sm font-medium ">{{ 'account_order_total_ex_vat'|_ }}&nbsp;</span>
            <span class="text-sm text-end">
                {{ orderProps.total_excl_vat ?? '—' }}{{ orderProps.total_excl_vat > 0 ? obOrder.currency_symbol : '' }}
            </span>
        </div>

        <div class="grid grid-cols-[30%_1fr] px-3 py-1">
            <span class="text-sm font-medium ">{{ 'account_order_total_with_vat'|_ }}&nbsp;</span>
            <span class="text-sm text-end">
                {{ orderProps.total_incl_vat ?? '—' }}{{ orderProps.total_incl_vat > 0 ? obOrder.currency_symbol : '' }}
            </span>
        </div>

        <div class="grid grid-cols-[30%_1fr] px-3 py-1">
            <span class="text-sm font-medium ">{{ 'account_order_notes'|_ }}&nbsp;</span>
            <span class="text-sm text-start">
                {{ orderProps.notes ?? '<div class="text-end">—</div>' }}
            </span>
        </div>

        <div class="grid grid-cols-[30%_1fr] px-3 py-1">
            <span class="text-sm font-medium ">{{ 'account_order_delivered'|_ }}&nbsp;</span>
            <span class="flex justify-end items-center">
                {{ obOrder.is_delivered ?
                    '<span class="inline-block w-3 h-3 rounded-full bg-green-500"></span>'
                    : '<span class="inline-block w-3 h-3 rounded-full bg-red-500"></span>'
                }}
            </span>
        </div>

        <div class="px-3 py-2">
            <span class="text-m font-medium">{{ 'account_order_see_more'|_ }}&nbsp;</span>
            <span class="text-m font-medium text-end">
                <button type="button" class="_toggle_button" data-toggle-id="{{ obOrder.order_number }}"><i class="bi bi-chevron-down _toggle_icon"></i></button>
            </span>
        </div>
    </div>
    <div class="bg-gray-50 border border-outline-variant py-2 hidden _order_details
    {% if not bRepeatOrder %}
        rounded-es-md rounded-ee-md
    {% endif %}
    " data-toggle-target="{{ obOrder.order_number }}">
        <div class="_order_position_list">
            {% for obOrderPosition in obOrderPositionList %}
                {% set obOffer = obOrderPosition.offer %}
                {% set obProduct = obOffer.product %}
                {% set obProductProps = obOrderPosition.property %}
                {% if obOffer.isNotEmpty() and obProduct.isNotEmpty() %}
                    <div class="grid grid-cols-1 gap-2 _order_position_list" data-offer-id="{{ obOffer.id }}" data-quantity="{{ obOrderPosition.quantity }}">
                        <div class="grid grid-cols-2 px-3 py-1">
                            <span class="text-sm font-medium">{{ 'account_order_position_code'|_ }}:&nbsp;</span>
                            <span class="text-sm text-end">
                                {{ obProduct.code }}
                            </span>
                        </div>
                        <div class="grid grid-cols-2 px-3 py-1">
                            <span class="text-sm font-medium">{{ 'account_order_position_name'|_ }}:&nbsp;</span>
                            <span class="text-sm text-end">
                                {{ obProduct.name }}
                            </span>
                        </div>
                        <div class="grid grid-cols-2 px-3 py-1">
                            <span class="text-sm font-medium">{{ 'account_order_position_um'|_ }}:&nbsp;</span>
                            <span class="text-sm text-end">
                                {{ obProductProps.unit_of_measure ?? '—' }}
                            </span>
                        </div>
                        <div class="grid grid-cols-2 px-3 py-1">
                            <span class="text-sm font-medium">{{ 'account_order_position_quantity'|_ }}:&nbsp;</span>
                            <span class="text-sm text-end">
                                {{ obOrderPosition.quantity }}
                            </span>
                        </div>
                        <div class="grid grid-cols-2 px-3 py-1">
                            <span class="text-sm font-medium">{{ 'account_order_position_quantity_delivered'|_ }}:&nbsp;</span>
                            <span class="text-sm text-end">
                                {{ obProductProps.deliverable_qty ?? '—' }}
                            </span>
                        </div>
                        <div class="grid grid-cols-2 px-3 py-1">
                            <span class="text-sm font-medium">{{ 'account_order_position_unit_price'|_ }}:&nbsp;</span>
                            <span class="text-sm text-end">
                                {{ obOrderPosition.price }}
                            </span>
                        </div>
                        <div class="grid grid-cols-2 px-3 py-1">
                            <span class="text-sm font-medium">{{ 'account_order_position_total_price'|_ }}:&nbsp;</span>
                            <span class="text-sm text-end">
                                {{ obProductProps.total_price ?? '—' }}{{ obProductProps.total_price > 0 ? obOrder.currency_symbol : '' }}
                            </span>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>

    {# Actions #}
    {% if bRepeatOrder %}
    <div class="bg-white border-b border-x border-outline-variant rounded-es-md rounded-ee-md overflow-hidden grid grid-cols-2 py-3 px-3">
        {% if obUser.can_order %}
        {% partial 'form/button'
        text='order_again'|_
        isGhost=true
        wrapperClasses='_order_again_button'
        %}
        {% endif %}
    </div>
    {% endif %}
</li>
{% endfor %}
